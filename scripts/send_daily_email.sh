#!/bin/bash
#
# Send Daily Health Reports via Email
# ä½¿ç”¨ Mail.app å‘é€æ¯æ—¥å¥åº·æŠ¥å‘Š
#

RECIPIENT="revolutionljk@gmail.com"
OUTPUT_DIR="/Users/jimmylu/.openclaw/workspace/shared/health-reports/upload"

# è®¡ç®—æ—¥æœŸ
YESTERDAY=$(date -v-1d '+%Y-%m-%d')
DAY_BEFORE=$(date -v-2d '+%Y-%m-%d')

echo "å‡†å¤‡å‘é€å¥åº·æŠ¥å‘Šé‚®ä»¶..."
echo "æ”¶ä»¶äºº: $RECIPIENT"
echo "æ˜¨æ—¥: $YESTERDAY"
echo "å‰å¤©: $DAY_BEFORE"

# å®šä¹‰æ–‡ä»¶è·¯å¾„
REPORT_ZH="${OUTPUT_DIR}/${YESTERDAY}-report-zh.pdf"
REPORT_EN="${OUTPUT_DIR}/${YESTERDAY}-report-en.pdf"
COMP_ZH="${OUTPUT_DIR}/${DAY_BEFORE}-vs-${YESTERDAY}-comparison-zh.pdf"
COMP_EN="${OUTPUT_DIR}/${DAY_BEFORE}-vs-${YESTERDAY}-comparison-en.pdf"

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
for file in "$REPORT_ZH" "$REPORT_EN" "$COMP_ZH" "$COMP_EN"; do
    if [ ! -f "$file" ]; then
        echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file"
        exit 1
    fi
done

echo "âœ… æ‰€æœ‰æŠ¥å‘Šæ–‡ä»¶å·²æ‰¾åˆ°"

# å‘é€é‚®ä»¶ 1: ä¸­æ–‡å•æ—¥æŠ¥å‘Š
osascript << EOF
tell application "Mail"
    set newMsg to make new outgoing message with properties {subject:"æ¯æ—¥å¥åº·æŠ¥å‘Š - ${YESTERDAY}", content:"æ‚¨å¥½ï¼Œ

è¯·æŸ¥æ”¶ ${YESTERDAY} çš„å¥åº·æŠ¥å‘Šï¼ˆä¸­æ–‡ç‰ˆï¼‰ã€‚

æŠ¥å‘ŠåŒ…å«ï¼š
- Recovery Score æ¢å¤è¯„åˆ†
- å¿ƒè¡€ç®¡æŒ‡æ ‡åˆ†æï¼ˆHRVã€é™æ¯å¿ƒç‡ï¼‰
- è¿åŠ¨æ•°æ®ç»Ÿè®¡ï¼ˆæ­¥æ•°ã€æ´»åŠ¨èƒ½é‡ã€é”»ç‚¼ï¼‰
- ç¡çœ è´¨é‡è¯„ä¼°
- AI ä¸ªæ€§åŒ–å»ºè®®

æ•°æ®æ¥æºï¼šApple Health + Google Fit
æ—¶åŒºï¼šUTC+8 (åŒ—äº¬æ—¶é—´)

å¦‚æœ‰ç–‘é—®ï¼Œè¯·éšæ—¶è”ç³»ã€‚

--
ç”± Health Agent è‡ªåŠ¨ç”Ÿæˆ"}
    tell newMsg
        make new to recipient at end of to recipients with properties {address:"${RECIPIENT}"}
        tell content
            make new attachment with properties {file name:"${REPORT_ZH}"}
        end tell
        send
    end tell
end tell
EOF

echo "âœ… é‚®ä»¶ 1/4 å·²å‘é€: ä¸­æ–‡å•æ—¥æŠ¥å‘Š"
sleep 2

# å‘é€é‚®ä»¶ 2: è‹±æ–‡å•æ—¥æŠ¥å‘Š
osascript << EOF
tell application "Mail"
    set newMsg to make new outgoing message with properties {subject:"Daily Health Report - ${YESTERDAY}", content:"Hello,

Please find attached your daily health report for ${YESTERDAY} (English version).

Report includes:
- Recovery Score
- Cardiovascular metrics (HRV, Resting Heart Rate)
- Activity data (Steps, Active Energy, Exercise)
- Sleep quality analysis
- AI personalized recommendations

Data sources: Apple Health + Google Fit
Timezone: UTC+8 (Beijing Time)

Best regards,
--
Generated by Health Agent"}
    tell newMsg
        make new to recipient at end of to recipients with properties {address:"${RECIPIENT}"}
        tell content
            make new attachment with properties {file name:"${REPORT_EN}"}
        end tell
        send
    end tell
end tell
EOF

echo "âœ… é‚®ä»¶ 2/4 å·²å‘é€: è‹±æ–‡å•æ—¥æŠ¥å‘Š"
sleep 2

# å‘é€é‚®ä»¶ 3: ä¸­æ–‡å¯¹æ¯”æŠ¥å‘Š
osascript << EOF
tell application "Mail"
    set newMsg to make new outgoing message with properties {subject:"å¥åº·å¯¹æ¯”æŠ¥å‘Š - ${DAY_BEFORE} vs ${YESTERDAY}", content:"æ‚¨å¥½ï¼Œ

è¯·æŸ¥æ”¶ ${DAY_BEFORE} ä¸ ${YESTERDAY} çš„å¥åº·å¯¹æ¯”åˆ†ææŠ¥å‘Šï¼ˆä¸­æ–‡ç‰ˆï¼‰ã€‚

æŠ¥å‘ŠåŒ…å«ï¼š
- ä¸¤æ—¥æ•°æ®å¹¶æ’å¯¹æ¯”
- AI æ¨¡å¼è¯†åˆ«ä¸æ´å¯Ÿ
- å˜åŒ–è¶‹åŠ¿åˆ†æ
- ä¸ªæ€§åŒ–å»ºè®®

AI ä¼šè‡ªåŠ¨è¯†åˆ«èº«ä½“çŠ¶æ€æ¨¡å¼ï¼ˆå¦‚"è¿‡åº¦é€æ”¯-èº«ä½“ä»£å¿"ï¼‰ï¼Œå¹¶æä¾›é’ˆå¯¹æ€§å»ºè®®ã€‚

--
ç”± Health Agent è‡ªåŠ¨ç”Ÿæˆ"}
    tell newMsg
        make new to recipient at end of to recipients with properties {address:"${RECIPIENT}"}
        tell content
            make new attachment with properties {file name:"${COMP_ZH}"}
        end tell
        send
    end tell
end tell
EOF

echo "âœ… é‚®ä»¶ 3/4 å·²å‘é€: ä¸­æ–‡å¯¹æ¯”æŠ¥å‘Š"
sleep 2

# å‘é€é‚®ä»¶ 4: è‹±æ–‡å¯¹æ¯”æŠ¥å‘Š
osascript << EOF
tell application "Mail"
    set newMsg to make new outgoing message with properties {subject:"Health Comparison Report - ${DAY_BEFORE} vs ${YESTERDAY}", content:"Hello,

Please find attached the health comparison report for ${DAY_BEFORE} vs ${YESTERDAY} (English version).

Report includes:
- Side-by-side data comparison
- AI pattern recognition and insights
- Trend analysis
- Personalized recommendations

AI automatically identifies body state patterns (e.g., "overdraft-compensation mode") and provides targeted advice.

Best regards,
--
Generated by Health Agent"}
    tell newMsg
        make new to recipient at end to recipients with properties {address:"${RECIPIENT}"}
        tell content
            make new attachment with properties {file name:"${COMP_EN}"}
        end tell
        send
    end tell
end tell
EOF

echo "âœ… é‚®ä»¶ 4/4 å·²å‘é€: è‹±æ–‡å¯¹æ¯”æŠ¥å‘Š"
echo ""
echo "ğŸ‰ æ‰€æœ‰å¥åº·æŠ¥å‘Šé‚®ä»¶å·²å‘é€æˆåŠŸï¼"
echo "æ”¶ä»¶äºº: ${RECIPIENT}"
echo "å‘é€æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
